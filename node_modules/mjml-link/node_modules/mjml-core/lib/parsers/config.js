'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _warning = require('warning');

var _warning2 = _interopRequireDefault(_warning);

var _some = require('lodash/some');

var _some2 = _interopRequireDefault(_some);

var _startsWith = require('lodash/startsWith');

var _startsWith2 = _interopRequireDefault(_startsWith);

var _isEmpty = require('lodash/isEmpty');

var _isEmpty2 = _interopRequireDefault(_isEmpty);

var _MJMLElementsCollection = require('../MJMLElementsCollection');

var _MJMLElementsCollection2 = _interopRequireDefault(_MJMLElementsCollection);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var cwd = process.cwd();

var isRelativePath = function isRelativePath(name) {
  return (0, _some2.default)(['./', '.', '../'], function (matcher) {
    return (0, _startsWith2.default)(name, matcher);
  });
};

var checkIfConfigFileExist = function checkIfConfigFileExist() {
  try {
    _fs2.default.statSync(cwd + '/.mjmlconfig');
    return true;
  } catch (e) {
    (0, _warning2.default)(!(0, _isEmpty2.default)(_MJMLElementsCollection2.default), 'No .mjmlconfig found in path ' + cwd + ', consider to add one');
    return false;
  }
};

var parseConfigFile = function parseConfigFile() {
  if (!checkIfConfigFileExist()) {
    return false;
  }

  try {
    return JSON.parse(_fs2.default.readFileSync(cwd + '/.mjmlconfig').toString());
  } catch (e) {
    (0, _warning2.default)(false, '.mjmlconfig has a ParseError: ' + e);
  }
};

var parsePackages = function parsePackages(packages) {
  if (!packages) {
    return;
  }

  packages.forEach(function (file) {
    if (!file) {
      return;
    }

    try {
      var filename = _path2.default.join(process.cwd(), file);
      var Component = isRelativePath(file) ? require(filename) : require.main.require(file);

      (0, _MJMLElementsCollection.registerMJElement)(Component.default || Component);
    } catch (e) {
      (0, _warning2.default)(false, '.mjmlconfig file ' + file + ' opened from ' + cwd + ' has an error : ' + e);
    }
  });
};

exports.default = function () {
  var config = parseConfigFile();

  if (!config) {
    return;
  }

  parsePackages(config.packages);
};